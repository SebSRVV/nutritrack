<div class="page fade-in" [@page]>
  <!-- Topbar -->
  <header class="topbar elevate slide-down">
    <div class="left">
      <h1>Metas alimentarias</h1>
      <p class="muted">Semana: {{ weekRangeLabel() }}</p>
    </div>

    <div class="actions">
      <div class="search">
        <input type="text" placeholder="Buscar metasâ€¦" (input)="search.set($any($event.target).value)" />
        <span class="kbd">/</span>
      </div>

      <select class="filter" (change)="filterActive.set($any($event.target).value)">
        <option value="all">Todas</option>
        <option value="active">Activas</option>
        <option value="inactive">Inactivas</option>
      </select>

      <button class="btn primary pulse" (click)="openNew()">+ Nueva meta</button>
    </div>
  </header>

  <!-- Content -->
  <section class="content">
    <div class="container">
      <div class="loading" *ngIf="loading()">Cargandoâ€¦</div>

      <div class="scroll-area" *ngIf="!loading()">
        <!-- ===== Presets SIEMPRE visibles ===== -->
        <div class="grid" aria-label="Metas sugeridas">
          <div class="section-title">
            <span>Metas sugeridas (presets)</span>
          </div>

          <div class="card hover-lift zoom-in clickable"
               *ngFor="let d of defaultsWithState()"
               (click)="goToDefault(d)"
               title="Ver preset / activar">
            <div class="card-head">
              <div class="title-wrap" style="justify-content:space-between; gap:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                  <h3 [class.inactive]="!d.is_active">{{ d.goal_name }}</h3>
                  <span class="badge" [class.badge-inactive]="!d.is_active">
                    {{ d.is_active ? 'Activo' : 'Inactivo' }}
                  </span>
                </div>

                <!-- Pill activar/desactivar -->
                <button class="switch"
                        role="switch"
                        [attr.aria-checked]="d.is_active"
                        (click)="$event.stopPropagation(); toggleDefault(d)">
                  <span class="dot"></span>
                  {{ d.is_active ? 'Desactivar' : 'Activar' }}
                </button>
              </div>
            </div>

            <!-- Progreso si estÃ¡ vinculado a un goal -->
            <div class="progress" *ngIf="d.bound_goal_id">
              <div class="bar">
                <div class="bar-fill"
                     [style.width.%]="progressFor(d.bound_goal_id).pct"
                     [attr.aria-valuenow]="progressFor(d.bound_goal_id).pct"></div>
              </div>
              <div class="progress-label">
                <strong>{{ progressFor(d.bound_goal_id).done }}/{{ progressFor(d.bound_goal_id).target }}</strong>
                <span>esta semana</span>
              </div>
            </div>

            <div class="card-actions">
              <button class="btn ghost" *ngIf="d.is_active"
                      (click)="$event.stopPropagation(); openEditDefault(d)">
                Personalizar
              </button>
              <!-- Defaults no se eliminan -->
            </div>
          </div>
        </div>

        <!-- ===== Mis metas (tarjetas) ===== -->
        <div class="grid" *ngIf="filteredGoals().length" aria-label="Mis metas">
          <div class="section-title"><span>Mis metas</span></div>

          <div class="card hover-lift zoom-in clickable"
               *ngFor="let g of filteredGoals()"
               (click)="goTo(g)"
               title="Ir al detalle">
            <div class="card-head">
              <div class="title-wrap" style="justify-content:space-between; gap:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                  <h3 [class.inactive]="!g.is_active">{{ g.goal_name }}</h3>
                  <span class="badge" [class.badge-inactive]="!g.is_active">
                    {{ g.is_active ? 'Activa' : 'Inactiva' }}
                  </span>
                </div>
                <span class="muted" style="font-size:12px;">Objetivo: {{ g.weekly_target }}/sem</span>
              </div>
              <p class="desc" *ngIf="g.description">{{ g.description }}</p>
            </div>

            <div class="progress">
              <div class="bar"><div class="bar-fill"
                                    [style.width.%]="progressFor(g.id).pct"></div></div>
              <div class="progress-label">
                <strong>{{ progressFor(g.id).done }}/{{ progressFor(g.id).target }}</strong>
                <span>esta semana</span>
              </div>
            </div>

            <div class="week">
              <div class="day" *ngFor="let d of weekDays()">
                <div class="day-label">{{ d.short }}</div>
                <button class="tick"
                        [class.on]="isChecked(g.id, d.iso)"
                        (click)="$event.stopPropagation(); toggleDaily(g, d.iso)"
                        [disabled]="saving()"
                        [attr.aria-pressed]="isChecked(g.id, d.iso)"
                        [title]="d.label">
                  <span class="dot"></span>
                </button>
              </div>
            </div>

            <div class="card-actions">
              <button class="btn ghost" (click)="$event.stopPropagation(); openEdit(g)">Editar</button>
              <button class="btn ghost" (click)="$event.stopPropagation(); toggleActive(g)">
                {{ g.is_active ? 'Pausar' : 'Reactivar' }}
              </button>
              <button class="btn danger" *ngIf="!g.default_id"
                      (click)="$event.stopPropagation(); deleteGoal(g)">Eliminar</button>
            </div>
          </div>
        </div>

        <!-- Empty: solo si no hay NADA que mostrar -->
        <div class="empty bounce-in" *ngIf="!filteredGoals().length && !defaultsWithState().length">
          <img src="https://illustrations.popsy.co/gray/goal.svg" alt="goals" />
          <h3>Sin metas por aquÃ­</h3>
          <p>Empieza creando una meta semanal. Â¡PequeÃ±os hÃ¡bitos, grandes cambios! ðŸ’ª</p>
          <button class="btn primary" (click)="openNew()">Crear meta</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Sheet Crear/Editar -->
  <div class="sheet-backdrop" *ngIf="uiNewGoalOpen()" (click)="uiNewGoalOpen.set(false)"></div>

  <div class="sheet slide-up" *ngIf="uiNewGoalOpen()">
    <div class="sheet-header">
      <h3>{{ uiEditGoalId() ? 'Editar meta' : 'Nueva meta' }}</h3>
      <button class="icon" (click)="uiNewGoalOpen.set(false)" aria-label="Cerrar">âœ•</button>
    </div>

    <div class="sheet-body">
      <label class="field">
        <span>TÃ­tulo</span>
        <input type="text"
               [value]="form().title"
               (input)="form.set({ title: $any($event.target).value, description: form().description, target_per_week: form().target_per_week })"
               placeholder="Ej. Aumentar vegetales"/>
      </label>

      <label class="field">
        <span>DescripciÃ³n (opcional)</span>
        <textarea rows="3"
                  [value]="form().description"
                  (input)="form.set({ title: form().title, description: $any($event.target).value, target_per_week: form().target_per_week })"
                  placeholder="Ej. AÃ±adir 2 porciones de verduras al dÃ­a"></textarea>
      </label>

      <label class="field">
        <span>Objetivo semanal</span>
        <input type="number" min="1" max="7"
               [value]="form().target_per_week"
               (input)="form.set({ title: form().title, description: form().description, target_per_week: +$any($event.target).value })"/>
        <small>Veces por semana (1â€“7)</small>
      </label>
    </div>

    <div class="sheet-footer">
      <button class="btn" (click)="uiNewGoalOpen.set(false)">Cancelar</button>
      <button class="btn primary" [disabled]="saving()" (click)="saveGoal()">
        {{ saving() ? 'Guardandoâ€¦' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>
