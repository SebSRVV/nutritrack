<div class="page fade-in" [@page]>
  <!-- Topbar -->
  <header class="topbar elevate slide-down">
    <!-- izquierda -->
    <div class="topbar-left">
      <button class="back" (click)="backToDashboard()" aria-label="Volver al dashboard" type="button">
        <lucide-icon [img]="ChevronLeftIcon" class="icon-18"></lucide-icon>
        Dashboard
      </button>
    </div>

    <!-- centro (título + semana) -->
    <div class="topbar-center">
      <h1 class="title">
        <lucide-icon [img]="TrophyIcon" class="icon-20"></lucide-icon>
        Metas alimentarias
      </h1>
      <p class="muted row">
        <lucide-icon [img]="CalendarDaysIcon" class="icon-16"></lucide-icon>
        Semana: {{ weekRangeLabel() }}
      </p>
    </div>

    <!-- derecha (placeholder para balance visual / futuros controles) -->
    <div class="topbar-right"></div>
  </header>

  <!-- Content -->
  <section class="content">
    <div class="container page-main">
      <div class="loading" *ngIf="loading()">Cargando…</div>

      <div class="scroll-area" *ngIf="!loading()">
        <!-- ===== Mis metas ===== -->
        <div class="grid" aria-label="Mis metas">
          <div class="section-title row">
            <lucide-icon [img]="ListChecksIcon" class="icon-16"></lucide-icon>
            <span>Mis metas</span>
          </div>

          <!-- Tarjetas -->
          <div class="card clickable"
               *ngFor="let g of goals(); trackBy: trackByGoal"
               (click)="openEdit(g)"
               title="Personalizar meta">
            <div class="card-head">
              <div class="title-wrap">
                <div class="row">
                  <lucide-icon [img]="TargetIcon" class="icon-16 soft"></lucide-icon>
                  <h3 [class.inactive]="!g.is_active">{{ g.goal_name }}</h3>
                  <span class="badge" [class.badge-inactive]="!g.is_active">
                    {{ g.is_active ? 'Activa' : 'Inactiva' }}
                  </span>
                </div>

                <!-- Switch -->
                <button class="switch"
                        role="switch"
                        [attr.aria-checked]="g.is_active ? 'true' : 'false'"
                        (click)="$event.stopPropagation(); toggleActiveSwitch(g)"
                        aria-label="Cambiar estado de la meta"
                        type="button">
                  <span class="dot"></span>
                  {{ g.is_active ? 'Activo' : 'Inactivo' }}
                </button>
              </div>

              <p class="desc" *ngIf="g.description">{{ g.description }}</p>
            </div>

            <!-- Progreso -->
            <ng-container *ngIf="progressFor(g.id) as p">
              <div class="progress" [ngClass]="progressMood(p.pct)">
                <div class="bar"><div class="bar-fill" [style.width.%]="p.pct"></div></div>
                <div class="progress-label">
                  <strong>{{ p.done }}/{{ p.target }}</strong>
                  <span>esta semana</span>
                </div>
              </div>
            </ng-container>

            <!-- Semana -->
            <div class="week">
              <div class="day" *ngFor="let d of weekDays(); trackBy: trackByDay">
                <div class="day-label">{{ d.short }}</div>
                <button class="tick"
                        [class.on]="isChecked(g.id, d.iso)"
                        (click)="$event.stopPropagation(); toggleDaily(g, d.iso)"
                        [disabled]="saving()"
                        [attr.aria-pressed]="isChecked(g.id, d.iso) ? 'true' : 'false'"
                        [title]="d.label"
                        type="button">
                  <span class="dot"></span>
                </button>
              </div>
            </div>

            <div class="card-actions">
              <button class="btn ghost" (click)="$event.stopPropagation(); openEdit(g)" type="button">
                <lucide-icon [img]="Settings2Icon" class="icon-16 v-2"></lucide-icon>
                &nbsp;Personalizar
              </button>
            </div>
          </div>
        </div>

        <!-- Empty -->
        <div class="empty fade-in" *ngIf="showEmpty()">
          <img src="https://illustrations.popsy.co/gray/goal.svg" alt="goals" />
          <h3>Sin metas por aquí</h3>
          <p>Configura tus 3 metas base con el botón “Personalizar”.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal centrado: Personalizar -->
  <div class="sheet-backdrop" *ngIf="uiNewGoalOpen()" (click)="uiNewGoalOpen.set(false)"></div>

  <div class="dialog slide-up" *ngIf="uiNewGoalOpen()" role="dialog" aria-modal="true" aria-label="Personalizar meta">
    <div class="dialog-header">
      <div class="row">
        <lucide-icon [img]="Settings2Icon" class="icon-18"></lucide-icon>
        <h3 class="m0">Personalizar meta</h3>
      </div>
      <button class="icon" (click)="uiNewGoalOpen.set(false)" aria-label="Cerrar" type="button">
        <lucide-icon [img]="XIcon" class="icon-18"></lucide-icon>
      </button>
    </div>

    <div class="dialog-body">
      <label class="field">
        <span>Título</span>
        <input type="text"
               [value]="form().title"
               (input)="form.set({ title: $any($event.target).value, description: form().description, target_per_week: form().target_per_week })"
               placeholder="Ej. Reducir azúcar"/>
      </label>

      <label class="field">
        <span>Descripción (opcional)</span>
        <textarea rows="3"
                  [value]="form().description"
                  (input)="form.set({ title: form().title, description: $any($event.target).value, target_per_week: form().target_per_week })"
                  placeholder="Ej. Evitar bebidas y postres 3 días"></textarea>
      </label>

      <label class="field two">
        <div>
          <span>Objetivo semanal</span>
          <input type="number" min="1" max="7"
                 [value]="form().target_per_week"
                 (input)="form.set({ title: form().title, description: form().description, target_per_week: +$any($event.target).value })"/>
          <small>Veces por semana (1–7)</small>
        </div>
      </label>
    </div>

    <div class="dialog-footer">
      <button class="btn" (click)="uiNewGoalOpen.set(false)" type="button">
        <lucide-icon [img]="XIcon" class="icon-16 v-2"></lucide-icon>
        &nbsp;Cancelar
      </button>
      <button class="btn primary" [disabled]="saving()" (click)="saveGoal()" type="button">
        <lucide-icon [img]="SaveIcon" class="icon-16 v-2"></lucide-icon>
        &nbsp;{{ saving() ? 'Guardando…' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>
