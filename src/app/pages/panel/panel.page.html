<section class="panel-root" *ngIf="!loading(); else skel">
  <header class="panel-header container">
    <a class="brand" routerLink="/" aria-label="Inicio NutriTrack"><strong>NutriTrack</strong></a>
    <nav class="actions">
      <label class="date-pick">
        <lucide-icon [img]="CalendarIcon"></lucide-icon>
        <input type="date" [value]="selectedDate()" (change)="onDateChange($any($event.target).value)" />
      </label>
      <a routerLink="/profile" class="btn ghost">
        <lucide-icon [img]="SettingsIcon"></lucide-icon> Configuraciones
      </a>
    </nav>
  </header>

  <div class="container grid">
    <!-- OVERVIEW -->
    <section class="card overview">
      <h2 class="title"><lucide-icon [img]="FlameIcon"></lucide-icon> Resumen del día</h2>

      <div class="meter" role="progressbar"
           [attr.aria-valuemin]="0" [attr.aria-valuemax]="recKcal()" [attr.aria-valuenow]="totalKcal()">
        <div class="bar" [style.width.%]="pct()"></div>
        <div class="value">{{ totalKcal() }} / {{ recKcal() }} kcal</div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="k">Proteína</div>
          <div class="v">{{ macros().protein_g }} g</div>
        </div>
        <div class="kpi">
          <div class="k">Carbos</div>
          <div class="v">{{ macros().carbs_g }} g</div>
        </div>
        <div class="kpi">
          <div class="k">Grasa</div>
          <div class="v">{{ macros().fat_g }} g</div>
        </div>
      </div>
    </section>

    <!-- CHARTS LEFT -->
    <section class="card charts">
      <h3 class="title"><lucide-icon [img]="PieChartIcon"></lucide-icon> Macronutrientes</h3>
      <canvas #donut height="200"></canvas>
    </section>

    <section class="card charts">
      <h3 class="title"><lucide-icon [img]="BarChart3Icon"></lucide-icon> Kcal por comida</h3>
      <canvas #mealsBar height="220"></canvas>
    </section>

    <!-- CHARTS RIGHT -->
    <section class="card charts full">
      <h3 class="title"><lucide-icon [img]="BarChart3Icon"></lucide-icon> Kcal por categorías</h3>
      <canvas #catsBar height="280"></canvas>
    </section>

    <section class="card charts full">
      <h3 class="title"><lucide-icon [img]="LineChartIcon"></lucide-icon> Kcal por hora</h3>
      <canvas #timeline height="220"></canvas>
    </section>

    <!-- LISTADO DEL DÍA -->
    <section class="card list">
      <h3 class="title">Registros del día</h3>
      <ul class="entries">
        <li class="entry" *ngFor="let r of logs()">
          <div class="left">
            <div class="desc">{{ r.description }}</div>
            <div class="meta">
              <span class="pill">{{ mealLabel(r.meal_type) }}</span>
              <span class="time">{{ fmtTime(r.logged_at) }}</span>
              <span class="pill" *ngFor="let c of (r.meal_categories || [])">{{ c }}</span>
            </div>
          </div>
          <div class="kcal"><lucide-icon [img]="FlameIcon"></lucide-icon> {{ r.calories }} kcal</div>
        </li>
        <li class="empty" *ngIf="logs().length===0">Sin registros para este día.</li>
      </ul>
    </section>

    <!-- ITEMS IA -->
    <section class="card items">
      <h3 class="title">Detalle de alimentos (IA)</h3>
      <div class="table">
        <div class="thead">
          <div>Alimento</div><div>Cantidad</div><div>Categorías</div><div class="right">kcal</div>
        </div>
        <div class="tbody">
          <div class="row" *ngFor="let it of aiFlatItems()">
            <div>{{ it.name }}</div>
            <div>{{ it.qty }} {{ it.unit || '' }}</div>
            <div class="cats">
              <span class="chip" *ngFor="let c of it.cats">{{ c }}</span>
            </div>
            <div class="right"><b>{{ it.kcal }}</b></div>
          </div>
          <div class="empty" *ngIf="aiFlatItems().length===0">No hay desgloses detectados por IA.</div>
        </div>
      </div>
    </section>
  </div>

  <p class="err center" *ngIf="err()">{{ err() }}</p>
</section>

<ng-template #skel>
  <div class="container loading">Cargando panel…</div>
</ng-template>
